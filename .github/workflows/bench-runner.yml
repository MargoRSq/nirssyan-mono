name: Benchmark Runner Comparison

on:
  push:
    branches: [bench/runner-comparison]

jobs:
  bench-timeweb:
    runs-on: infatium-ko
    steps:
      - name: Record start
        id: start
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: false

      - name: Record setup done
        id: setup_done
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Install ko
        run: |
          if [ ! -f "$GOPATH/bin/ko" ]; then
            go install github.com/google/ko@v0.17.1
          fi

      - name: Record ko done
        id: ko_done
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Build go-api
        env:
          GOFLAGS: "-trimpath -buildvcs=false"
          CGO_ENABLED: "0"
          GOOS: "linux"
          GOARCH: "amd64"
        working-directory: services/go-api
        run: go build -o /tmp/go-api ./cmd/api

      - name: Record build done
        id: build_done
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Print timings
        id: timings
        run: |
          fmt() { echo "$((($1) / 60))m $(($1 % 60))s"; }
          SETUP=$((${{ steps.setup_done.outputs.time }} - ${{ steps.start.outputs.time }}))
          KO=$((${{ steps.ko_done.outputs.time }} - ${{ steps.setup_done.outputs.time }}))
          BUILD=$((${{ steps.build_done.outputs.time }} - ${{ steps.ko_done.outputs.time }}))
          TOTAL=$((${{ steps.build_done.outputs.time }} - ${{ steps.start.outputs.time }}))
          echo "## Timeweb VPS (infatium-ko)"
          echo "Setup Go: $(fmt $SETUP)"
          echo "Install ko: $(fmt $KO)"
          echo "Build: $(fmt $BUILD)"
          echo "TOTAL: $(fmt $TOTAL)"
          echo "setup=$SETUP" >> $GITHUB_OUTPUT
          echo "ko=$KO" >> $GITHUB_OUTPUT
          echo "build=$BUILD" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Send to Telegram
        run: |
          curl -s -X POST "https://api.telegram.org/bot8162983730:AAET6ZLo73MpHSOOhXyBrmhw7x03tnOAaUg/sendMessage" \
            -H "Content-Type: application/json" \
            -d '{
              "chat_id": "-1002622491758",
              "message_thread_id": 161,
              "text": "ðŸ§ª <b>Bench: Timeweb VPS (infatium-ko)</b>\n\nSetup Go: ${{ steps.timings.outputs.setup }}s\nInstall ko: ${{ steps.timings.outputs.ko }}s\nBuild: ${{ steps.timings.outputs.build }}s\n<b>TOTAL: ${{ steps.timings.outputs.total }}s</b>\n\ntest message",
              "parse_mode": "HTML"
            }'

  bench-vm101:
    runs-on: infatium-ko-bench
    steps:
      - name: Record start
        id: start
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: false

      - name: Record setup done
        id: setup_done
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Install ko
        run: |
          if [ ! -f "$GOPATH/bin/ko" ]; then
            go install github.com/google/ko@v0.17.1
          fi

      - name: Record ko done
        id: ko_done
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Build go-api
        env:
          GOFLAGS: "-trimpath -buildvcs=false"
          CGO_ENABLED: "0"
          GOOS: "linux"
          GOARCH: "amd64"
        working-directory: services/go-api
        run: go build -o /tmp/go-api ./cmd/api

      - name: Record build done
        id: build_done
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Print timings
        id: timings
        run: |
          fmt() { echo "$((($1) / 60))m $(($1 % 60))s"; }
          SETUP=$((${{ steps.setup_done.outputs.time }} - ${{ steps.start.outputs.time }}))
          KO=$((${{ steps.ko_done.outputs.time }} - ${{ steps.setup_done.outputs.time }}))
          BUILD=$((${{ steps.build_done.outputs.time }} - ${{ steps.ko_done.outputs.time }}))
          TOTAL=$((${{ steps.build_done.outputs.time }} - ${{ steps.start.outputs.time }}))
          echo "## VM 101 Ryzen (infatium-ko-bench)"
          echo "Setup Go: $(fmt $SETUP)"
          echo "Install ko: $(fmt $KO)"
          echo "Build: $(fmt $BUILD)"
          echo "TOTAL: $(fmt $TOTAL)"
          echo "setup=$SETUP" >> $GITHUB_OUTPUT
          echo "ko=$KO" >> $GITHUB_OUTPUT
          echo "build=$BUILD" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Send to Telegram
        run: |
          curl -s -X POST "https://api.telegram.org/bot8162983730:AAET6ZLo73MpHSOOhXyBrmhw7x03tnOAaUg/sendMessage" \
            -H "Content-Type: application/json" \
            -d '{
              "chat_id": "-1002622491758",
              "message_thread_id": 161,
              "text": "ðŸ§ª <b>Bench: VM 101 Ryzen (infatium-ko-bench)</b>\n\nSetup Go: ${{ steps.timings.outputs.setup }}s\nInstall ko: ${{ steps.timings.outputs.ko }}s\nBuild: ${{ steps.timings.outputs.build }}s\n<b>TOTAL: ${{ steps.timings.outputs.total }}s</b>\n\ntest message",
              "parse_mode": "HTML"
            }'
